# リグレッションテスト仕様書

## 概要
ディレクトリ構造統一とコードベースクリーンアップ後の全機能動作確認

## テスト実行方針
### 🤖 自動化優先の原則
- **目的**: 定期的なリグレッションテストをカジュアルに実行できるようにする
- **方針**: 
  - テスト開始時に必要な確認事項をすべて収集
  - その後は特別な事情がない限り全自動で完了まで実行
  - 人的介入を最小限に抑え、CI/CDへの組み込みを容易にする
- **確認タイミング**:
  - テスト実行前: 環境設定、認証情報、実行範囲の確認
  - テスト実行中: エラー発生時のみ（自動リトライ後）
  - テスト完了後: 結果レポートの確認のみ

## テスト環境
- AWS Account: 498997347996
- Region: ap-northeast-1
- Environment: dev
- 実施日: 2025-07-04

## 前提条件
- [ ] すべてのスタックがdestroyで削除済み
- [ ] CDK Bootstrap環境も削除済み
- [ ] 環境変数ファイル(.env)が存在しない

## テスト項目

### 1. 基本機能テスト

#### 1.1 Bootstrap処理
**目的**: CDK Bootstrap環境が利用可能であることを確認

**手順**:
1. 既存のCDKToolkitスタックの状態を確認
2. 正常な場合はそのまま使用
3. 存在しない場合のみ`./scripts/bootstrap.sh`を実行

**期待結果**:
- CDKToolkitスタックがCREATE_COMPLETE/UPDATE_COMPLETEになる
- アセット用S3バケットが利用可能
- **重要**: 既存のBootstrapは保持され、他の環境に影響しない

#### 1.2 Setup処理
**目的**: 環境セットアップが正常に動作することを確認

**手順**:
1. `./scripts/setup.sh`を実行
2. 対話形式で以下を入力:
   - Environment: dev
   - AWS Account ID: 498997347996
   - AWS Region: ap-northeast-1
   - Discord Bot Token: (テスト用トークン)
   - Discord Guild ID: (テスト用ID)
3. .envファイルの生成を確認

**期待結果**:
- .envファイルが生成される
- 環境変数が正しく設定される
- node_modulesがインストールされる

#### 1.3 Deploy処理
**目的**: スタックのデプロイが正常に動作することを確認

**手順**:
1. `./scripts/deploy.sh dev`を実行
2. 各スタックのデプロイ状況を確認:
   - network
   - storage
   - bot-api
   - cache-api

**期待結果**:
- すべてのスタックがCREATE_COMPLETEになる
- Lambda関数が作成される
- DynamoDBテーブルが作成される
- エラーメッセージが表示されない

### 2. Lambda関数テスト

#### 2.1 Hello関数テスト
**目的**: bot-api/helloエンドポイントが正常に動作することを確認

**手順**:
1. API GatewayのURLを取得
2. `curl https://{api-id}.execute-api.ap-northeast-1.amazonaws.com/prod/hello`を実行

**期待結果**:
- HTTP 200が返される
- "Hello from Lambda!"メッセージが返される

#### 2.2 Discord関数テスト
**目的**: bot-api/discordエンドポイントが正常に動作することを確認

**手順**:
1. API GatewayのURLを取得
2. Discord Botトークンの設定を確認
3. `curl https://{api-id}.execute-api.ap-northeast-1.amazonaws.com/prod/discord/member/123456`を実行

**期待結果**:
- HTTP 200または404が返される（ユーザー存在有無による）
- エラーレスポンスの場合も適切なエラーメッセージ

### 3. 外部連携テスト

#### 3.1 Discord API連携
**目的**: Discord APIとの通信が正常に動作することを確認

**手順**:
1. 実際のDiscord Guild IDとBot Tokenを設定
2. 存在するユーザーIDでAPIを呼び出し
3. 存在しないユーザーIDでAPIを呼び出し

**期待結果**:
- 存在するユーザー: ユーザー情報が返される
- 存在しないユーザー: 404エラーが返される
- API認証エラーが発生しない

#### 3.2 DynamoDB操作
**目的**: DynamoDBテーブルへの読み書きが正常に動作することを確認

**手順**:
1. AWS ConsoleでDynamoDBテーブルを確認
2. cache-apiを通じてデータを書き込み
3. 書き込んだデータを読み込み

**期待結果**:
- テーブルが作成されている
- データの書き込みが成功する
- データの読み込みが成功する

### 4. 設定・環境テスト

#### 4.1 環境変数
**目的**: 環境変数が正しく読み込まれることを確認

**手順**:
1. .envファイルの内容を確認
2. Lambda関数のログで環境変数の読み込みを確認

**期待結果**:
- すべての必須環境変数が設定されている
- Lambda関数で環境変数が利用できる

#### 4.2 マルチ環境対応
**目的**: dev/staging/prod環境の切り替えが正常に動作することを確認

**手順**:
1. `./scripts/diff.sh dev`を実行
2. `./scripts/diff.sh staging`を実行（.env.stagingが必要）

**期待結果**:
- 環境ごとに異なるスタック名が使用される
- 環境変数が正しく切り替わる

### 5. 運用機能テスト

#### 5.1 エラーハンドリング
**目的**: エラー発生時の挙動が適切であることを確認

**手順**:
1. 不正なリクエストをAPIに送信
2. CloudWatch Logsでエラーログを確認

**期待結果**:
- 適切なHTTPステータスコードが返される
- エラーログが記録される
- スタックトレースが含まれる

#### 5.2 ログ出力
**目的**: ログが適切に出力されることを確認

**手順**:
1. 各Lambda関数を実行
2. CloudWatch Logsでログを確認

**期待結果**:
- リクエスト/レスポンスログが記録される
- タイムスタンプが含まれる
- ログレベルが適切

#### 5.3 デプロイスクリプト
**目的**: 各種スクリプトが正常に動作することを確認

**手順**:
1. `./scripts/list-stacks.sh`を実行
2. `./scripts/investigate-stack.sh dev storage`を実行
3. `./scripts/help.sh`を実行

**期待結果**:
- スタック一覧が表示される
- スタックの詳細情報が表示される
- ヘルプメッセージが表示される

### 6. クリーンアップテスト

#### 6.1 Destroy処理
**目的**: スタックの削除が正常に動作することを確認

**手順**:
1. `./scripts/destroy.sh dev`を実行
2. 削除確認でyesを入力

**期待結果**:
- すべてのスタックが削除される
- リソースが残らない

## チェックリスト

### 実行前チェック
- [ ] AWS CLIが設定されている
- [ ] CDK CLIがインストールされている
- [ ] Node.js v20がインストールされている
- [ ] 必要な権限がある

### 実行後チェック
- [ ] すべてのテストが成功
- [ ] エラーログがない
- [ ] リソースがクリーンアップされている
- [ ] ドキュメントと実装が一致している

## 結果記録

### 実施者情報
- 実施者: 
- 実施日時: 
- 環境: dev

### テスト結果サマリ
| テスト項目 | 結果 | 備考 |
|------------|------|------|
| Bootstrap処理 | - | - |
| Setup処理 | - | - |
| Deploy処理 | - | - |
| Lambda関数 | - | - |
| Discord連携 | - | - |
| DynamoDB操作 | - | - |
| エラーハンドリング | - | - |
| ログ出力 | - | - |
| デプロイスクリプト | - | - |
| Destroy処理 | - | - |

### 発見された問題
1. 

### 改善提案
1. 

## 参考情報
- [CDKマニュアル](../guides/cdk-manual.md)
- [アーキテクチャ設計書](../design/application-architecture.md)
- [スタックテスト仕様](./stack-test-specifications.md)